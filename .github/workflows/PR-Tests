name: PR Tests

on:
  pull_request:
    branches:
      - master

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Detect P0 PR ‚Äî if found skip tests immediately
      - name: P0 Quick Check
        id: p0check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const msg = (pr.title + " " + pr.body).toUpperCase();

            if (msg.includes("P0")) {
              console.log("üü¢ P0 override detected ‚Äî skipping tests");
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: pr.head.sha,
                state: 'success',
                context: 'PR test',
                description: 'P0 ‚Äî Tests skipped',
              });
              return { skip: 'true' };
            } else {
              console.log("‚è≥ Regular PR ‚Äî testing required");
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: pr.head.sha,
                state: 'pending',
                context: 'PR test',
                description: 'Running automated tests...',
              });
              return { skip: 'false' };
            }

      # 2Ô∏è‚É£ Skip everything if P0
      - name: Stop workflow on P0
        if: steps.p0check.outputs.skip == 'true'
        run: exit 0

      # 3Ô∏è‚É£ Checkout demoServer code
      - name: Checkout demoServer
        uses: actions/checkout@v3

      # 4Ô∏è‚É£ Checkout demoTest repo
      - name: Checkout demoTest
        uses: actions/checkout@v3
        with:
          repository: AravinthSang/demoTest
          token: ${{ secrets.PAT_TOKEN }}
          path: demoTest
          fetch-depth: 1

      # 5Ô∏è‚É£ Install dependencies for server
      - name: Install server dependencies
        run: npm install

      # 6Ô∏è‚É£ Start server locally
      - name: Start server
        run: |
          npm start &
          sleep 3

      # 7Ô∏è‚É£ Install dependencies for demoTest
      - name: Install test dependencies
        run: |
          cd demoTest
          npm install

      # 8Ô∏è‚É£ Run playwright tests
      - name: Run Tests
        id: tests
        run: |
          cd demoTest
          npx playwright test
        continue-on-error: true

      # 9Ô∏è‚É£ Publish final result
      - name: Publish final test status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const failed = steps.tests.outcome !== "success";

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.head.sha,
              state: failed ? 'failure' : 'success',
              context: 'PR test',
              description: failed ? '‚ùó Tests failed' : '‚úÖ Tests passed',
            });
