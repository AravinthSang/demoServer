name: main

on:
  push:
    branches: [master]

jobs:
  run-live-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Check P0 override
        id: p0check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitMsg = context.payload.head_commit.message;
            const isP0 = commitMsg.includes("P0");

            core.setOutput("p0", isP0 ? "true" : "false");
            console.log("Commit Message:", commitMsg);
            console.log("P0 Override:", isP0);

      - name: Publish override success status
        if: steps.p0check.outputs.p0 == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log("‚ö†Ô∏è P0 detected, skipping tests and marking as success");
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'main',
              description: 'üü° P0 override ‚Äì merge allowed without tests',
            });

      - name: Checkout test repo
        if: steps.p0check.outputs.p0 != 'true'
        uses: actions/checkout@v4
        with:
          repository: sachanand/event-certificate-wm-test-automation-playwritght-25-26
          path: .
          ref: feature
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        if: steps.p0check.outputs.p0 != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.p0check.outputs.p0 != 'true'
        run: |
          npm install

      - name: Install Chromium
        if: steps.p0check.outputs.p0 != 'true'
        run: |
          npx playwright install chromium

      - name: Run LIVE functional tests
        if: steps.p0check.outputs.p0 != 'true'
        id: tests
        run: |
          BASE_URL="https://certificate.webmobi.com/"
          echo "Using BASE_URL=$BASE_URL"
          npm test functional || echo "TESTS_FAILED=true" >> $GITHUB_ENV

      - name: Publish final test status
        if: steps.p0check.outputs.p0 != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_FOR_STATUS }}
          script: |
            const failed = process.env.TESTS_FAILED === "true";

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: failed ? 'failure' : 'success',
              context: 'main',
              description: failed ? '‚ùó LIVE tests failed' : '‚úÖ LIVE tests passed',
            });
